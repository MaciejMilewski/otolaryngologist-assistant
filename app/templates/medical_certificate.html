<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="{{ url_for('static',filename='img/logo.png') }}">

    <title>Orzeczenia lekarskie</title>

    <!-- Icon -->
    <link href="{{ url_for('static', filename='img/logo.png') }}" rel="shortcut icon">
    <!-- Import Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <!-- Import Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <!-- CSS forms_input_data.css -->
    <link href="{{ url_for('static', filename='css/medical_certificate.css') }}" rel="stylesheet">
    <!-- Import jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Import Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

</head>
<body>

<div class="col-12 text-center">
    <div class="row">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} text-center" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container col-12" id="mainForm">
        <!-- Pasek nawigacji -->
        <div class="row">
            <nav class="navbar fixed-top navbar-expand-lg navbar-light" style="background-color: #e3f2fd;">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="{{ url_for('static',filename='img/logo.png') }}" alt="" width="60" height="60"
                             class="d-inline-block align-text-top">
                    </a>
                    <a class="navbar-brand"><h5>{% if current_user.is_authenticated %}<b>{{ user }}</b>{% endif %}</h5>
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent"
                            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="btn btn-outline-primary" type="button"
                                   href="{{ url_for('antibiotic.antibiotic_main') }}">Antybiotykoterapia</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-success" type="button"
                                   href="{{ url_for('visit.main_form') }}">Badanie</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-secondary" type="button"
                                   href="{{ url_for('medical_certificate.medical_certificate_main') }}">Orzeczenia</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-warning" type="button"
                                   href="{{ url_for('patient.patient_main') }}">Szukaj
                                    pacjenta</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-info" type="button"
                                   href="{{ url_for('instruction.instruction_main') }}">Instrukcje</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-dark" type="button"
                                   href="{{ url_for('procedure.procedure_main') }}">Procedury
                                    NFZ</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-dark" type="button"
                                   href="{{ url_for('schedule.schedule_main') }}">Terminarz</a>
                            </li>
                        </ul>
                        <a class="btn btn-danger" type="button" href="{{ url_for('auth.logout') }}">Wyloguj się</a>
                    </div>
                </div>
            </nav>
        </div>

        <div class="row d-flex align-items-stretch" style="margin-top: 96px;">
            <!-- Formularz 1 - orzeczenia -->
            <div class="col-md-8 mb-3">
                <form action="{{ url_for('medical_certificate.save') }}" method="post" id="medical_certificate_form">

                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <div class="card h-100">
                        <div class="card-header mb-3 py-3">
                            <h4 class="mb-0"><span class="badge bg-success">ORZECZENIA LEKARSKIE</span></h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="typ">Typ orzeczenia</label>
                                    <select id="typ" class="form-select select2" name="typ" aria-label="Typ badania">
                                        {% for choice in typ %}
                                            <option value="{{ choice['id'] }}"> {{ choice['name'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="place">Lokalizacja</label>
                                    <select id="place" class="form-select select2" name="place"
                                            aria-label="Lokalizacja">
                                        {% for locale in place %}
                                            <option value="{{ locale['name'] }}"> {{ locale['name'] }},
                                                dnia {{ today }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="add_information">ROZPOZNANIA / DODATKOWE
                                    INFORMACJE</label>
                                <textarea class="form-control" name="add_information" id="add_information"
                                          rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <div class="form-check d-flex justify-content-end align-items-center mb-3">
                                    <label class="form-check-label ms-2 zdolny-label" for="zdolny">&nbsp;&nbsp; Zdolność
                                        do
                                        pracy</label>
                                    <input class="form-check-input ms-2" type="checkbox" id="zdolny" name="zdolny"
                                           value="1"
                                           checked>
                                </div>
                            </div>

                            <div class="mb-3">
                                <input type="hidden" id="hiddenResultInput" name="hiddenResultInput" value=""/>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="first_name" class="form-label">Imię</label>
                                        <input type="text" id="first_name" name="first_name" class="form-control"
                                               required
                                               placeholder="Wpisz imię pacjenta"
                                               pattern="[A-Za-zĄĆĘŁŃÓŚŹŻąćęłńóśźż\s]+" title="Wprowadź tylko litery">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="surname" class="form-label">Nazwisko</label>
                                        <input type="text" id="surname" name="surname" class="form-control" required
                                               placeholder="Wpisz nazwisko pacjenta"
                                               pattern="[A-Za-zĄĆĘŁŃÓŚŹŻąćęłńóśźż'\s]+" title="Wprowadź tylko litery">
                                        <span id="pesel-error" class="error" aria-live="polite"></span>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="pesel" class="form-label">PESEL</label>
                                        <input type="text" id="pesel" name="pesel" class="form-control"
                                               placeholder="Wpisz 11-cyfrowy numer"
                                               pattern="[0-9]{11}" maxlength="11" inputmode="numeric" required>
                                    </div>

                                </div>
                            </div>

                            <div class="mb-3">

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="wojewodztwo" class="form-label">Województwo</label>
                                        <select id="wojewodztwo" name="wojewodztwo" class="form-select select2">
                                            {% for key, nazwa in woj.items() %}
                                                <option value="{{ key }}">{{ nazwa }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="city_select" class="form-label">Miejscowość</label>
                                        <select id="city_select" name="city_select" class="form-select select2">
                                            {% for city in cities %}
                                                <option value="{{ city }}"
                                                        {% if city == city_default %}selected{% endif %}>{{ city }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="street" class="form-label">Ulica</label>
                                        <select id="street" name="street" class="form-select select2">
                                            {% for street in streets %}
                                                <option value="{{ street }}"
                                                        {% if street == street_default %}selected{% endif %}>{{ street }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label for="home_numer" class="form-label">Numer</label>
                                        <input type="text" id="home_numer" name="home_numer" class="form-control"
                                               placeholder="Numer domu" required>
                                    </div>

                                </div>
                            </div>

                            <div class="d-flex flex-wrap justify-content-between gap-2">
                                <button type="button" class="btn btn-danger flex-grow-1" id="clearForm">
                                    <i class="bi bi-trash"></i> CZYŚĆ
                                </button>
                                <button type="submit" class="btn btn-primary flex-grow-1" id="pdf_Form"
                                        data-bs-toggle="modal"
                                        data-action="print"
                                        data-bs-target="#modalForm"
                                        formaction="{{ url_for('medical_certificate.medical_certificate_pdf') }}">
                                    <i class="bi bi-file-earmark-pdf"></i> PDF
                                </button>
                                <button type="submit" class="btn btn-success flex-grow-1" id="saveButton"
                                        data-bs-toggle="modal"
                                        data-action="save"
                                        data-bs-target="#modalForm">
                                    <i class="bi bi-save"></i> ZAPISZ
                                </button>
                                <button type="button" class="btn btn-info custom-raport-btn flex-grow-1"
                                        id="raportButton"
                                        onclick="window.location.href='{{ url_for('medical_certificate.raport') }}'">
                                    <i class="bi bi-bar-chart-line"></i> RAPORT
                                </button>
                            </div>

                        </div>
                    </div>
                </form>
            </div>

            <!-- Formularz 2 - Skala Hirano -->
            <div class="col-md-4 mb-3">
                <div class="card ">
                    <div class="card-header py-3">
                        <h4 class="mb-0">
                            <span class="badge bg-success">Skala GRBAS</span>
                            <sup><i>&nbsp;wg Hirano, 1981</i></sup>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <label for="grade" class="me-2">G<i>-stopień chrypki</i></label>
                            <select name="grade" id="grade" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="roughness" class="me-2">R<i>-szorstkość głosu</i></label>
                            <select name="roughness" id="roughness" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="breathiness" class="me-2">B<i>–głos chuchający</i></label>
                            <select name="breathiness" id="breathiness" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="asthenic" class="me-2">A<i>–głos słaby, asteniczny</i></label>
                            <select name="asthenic" id="asthenic" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="strained" class="me-2">S<i>–głos hiperfunkcjonalny</i></label>
                            <select name="strained" id="strained" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <button id="GRBAS" class="btn btn-success mt-3 w-100">
                            <i class="bi bi-check-circle"></i> ZATWIERDŹ
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal Autocomplete -->
        <div class="modal fade" id="autocompleteModal" tabindex="-1" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Autouzupełnianie</h5>
                        <img alt="zapis" class="float-end" width="60" height="60"
                             src="{{ url_for('static', filename='img/dane_osobowe.jpg') }}">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="autocompleteSelect">Pacjenci</label>
                            <select id="autocompleteSelect" class="form-control select2"></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Import Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <!-- Custom JS -->
    <script>
        $(document).ready(function () {

            const wojewodztwoSelect = $('#wojewodztwo');
            const citySelect = $('#city_select');
            const streetSelect = $('#street');

            // ### Funkcja pomocnicza ###
            /*
            function setSelect2OptionByText(selectElement, textValue) {
                // Sprawdź, czy element select ma id 'wojewodztwo'
                if (selectElement.attr('id') === 'wojewodztwo') {
                    // Jeśli tak, ustaw wartość na textValue
                    selectElement.val(textValue).trigger('change.select2');
                } else {
                    // W przeciwnym razie wyszukaj opcję po tekście
                    const option = selectElement.find('option').filter(function () {
                        return $(this).text().trim() === textValue;
                    });
                    if (option.length > 0) {
                        selectElement.val(option.val()).trigger('change.select2');
                    } else {
                        console.warn("Nie znaleziono opcji w select:", textValue, ' - ', selectElement.attr('id'));
                    }
                }
            }

             */

            function setSelect2OptionByText(selectElement, value) {
                // Sprawdź, czy wartość istnieje w opcjach
                if (!selectElement.find(`option[value="${value}"]`).length) {
                    // Jeśli nie istnieje, dodaj ją jako nową opcję
                    const newOption = new Option(value, value, true, true);
                    {#console.log("selectElement", selectElement)#}
                    {#console.log("value", value)#}
                    selectElement.append(newOption);
                }

                // Ustaw wartość i odśwież Select2
                selectElement.val(value).trigger('change.select2');
            }


            // ### Pobieranie ulic ###
            function updateStreets(selectedStreet = null) {
                return new Promise((resolve, reject) => {
                    const miejscowosc = citySelect.find(":selected").text(); // Wybrana miejscowość
                    const sym = citySelect.find(":selected").val(); // Symbol miejscowości

                    // Walidacja danych wejściowych
                    if (!miejscowosc || !sym) {
                        console.error("Brak miejscowości lub symbolu miejscowości do pobrania ulic.");
                        return reject("Nie wybrano miejscowości.");
                    }

                    // Pobierz token CSRF ze źródła (np. metatag, ukryty input w stronie itp.)
                    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;

                    $.ajax({
                        url: '/get_ulice', // Endpoint serwera
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({sym: sym}), // Przesyłanie symbolu miejscowości
                        headers: {
                            'X-CSRFToken': csrfToken // Dodanie tokena CSRF do nagłówka
                        },
                        success: function (response) {
                            // Resetuj Select2 dla ulic
                            streetSelect.empty();

                            const fragment = document.createDocumentFragment(); // Fragment do optymalizacji DOM

                            if (Array.isArray(response) && response.length > 0) {
                                // Dodaj ulice
                                response.forEach(street => {
                                    fragment.appendChild(new Option(street.name, street.name));
                                });

                                streetSelect.append(fragment).trigger('change.select2');

                                resolve("Ulice zostały załadowane.");
                            } else {
                                console.warn("Brak ulic dla wybranej miejscowości.");
                                streetSelect.append(new Option("Brak dostępnych ulic!", "", false, false)).trigger('change.select2');
                                resolve("Brak ulic dla wybranej miejscowości.");
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error("Błąd podczas pobierania ulic:", textStatus, errorThrown);
                            streetSelect.empty().append(new Option("Błąd w pobieraniu danych", "", false, false));
                            streetSelect.trigger('change.select2');
                            reject(errorThrown);
                        }
                    });
                });
            }


            // ### Pobieranie miast ###
            function loadCities(wojewodztwo) {
                return new Promise((resolve, reject) => {
                    if (!wojewodztwo) {
                        return reject("Brak wybranego województwa.");
                    }
                    // Pobierz token CSRF ze źródła (np. metatag, ukryty input w stronie itp.)
                    const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
                    $.ajax({
                        url: '/get_miejscowosci',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({wojewodztwo: wojewodztwo}),
                        headers: {
                            'X-CSRFToken': csrfToken // Dodanie tokena CSRF do nagłówka
                        },
                        success: function (response) {

                            // Resetuj pola miast i ulic
                            citySelect.empty();
                            streetSelect.empty();

                            {#console.log("Response length", response.length)#}
                            {#console.log("Response", response)#}
                            // Sprawdź, czy są miejscowości
                            if (response && response.length > 0) {
                                const fragment = document.createDocumentFragment();
                                response.forEach(city => {
                                    const option = new Option(city.name, city.sym); // Użyj name jako tekst, sym jako wartość
                                    fragment.appendChild(option);
                                });
                                citySelect.append(fragment);
                                // Wymuś odświeżenie Select2
                                citySelect.trigger('change.select2');

                                resolve(); // Rozwiązanie Promise

                                // Załaduj ulice dla pierwszego miasta (opcjonalnie)
                                if (response[0]) {
                                    updateStreets(response[0].sym);
                                }
                            } else {
                                console.warn("Brak dostępnych miejscowości dla województwa:", wojewodztwo);
                                reject("Brak dostępnych miejscowości.");
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error("Błąd podczas pobierania miejscowości:", textStatus, errorThrown);
                        }
                    });
                });
            }

            // ### Inicjalizacja Select2 ###
            function initializeSelect2() {

                $('.select2').select2({
                    language: "en",
                    placeholder: "Wybierz",
                    allowClear: false,
                    width: '100%',
                    debug: true,
                    sorter: function (results) {
                        // Pobranie tekstu wyszukiwanego przez użytkownika
                        var query = $('.select2-search__field').val().toLowerCase();
                        return results.sort(function (a, b) {
                            // Sortowanie w oparciu o pozycję tekstu w opcji
                            return a.text.toLowerCase().indexOf(query) - b.text.toLowerCase().indexOf(query);
                        });
                    }
                });

                wojewodztwoSelect.val('22').trigger('change.select2'); // Default: POMORSKIE
            }

            // ### wypełnij select2 autocompleteSelect ###
            function populateAutocompleteModal(results) {
                const autocompleteSelect = $('#autocompleteSelect');
                const fragment = document.createDocumentFragment();

                // Wyczyść istniejące opcje
                autocompleteSelect.empty();

                // Dodaj opis na belce startowej wyszukiwania
                const defaultOption = new Option('Lista rozwijana z wynikami ...', '', false, false);
                fragment.appendChild(defaultOption);

                // Dodaj nowe wyniki jako opcje, jeśli wyniki są dostępne
                if (results && results.length > 0) {
                    results.forEach((result) => {
                        // dodaj imię, nazwisko i pesel z 'result'
                        const displayText = result[1] + ' ' + result[2] + ' ' + result[3];
                        const newOption = new Option(displayText, result[0], false, false);
                        $(newOption).data('fullData', result); // dodaj cały 'result'
                        fragment.appendChild(newOption);
                    });
                } else {
                    // Dodaj opcję informującą o braku wyników
                    const noResultsOption = new Option('Brak wyników !', '', false, false);
                    fragment.appendChild(noResultsOption);
                }

                // Przenieś fragment do Select2
                autocompleteSelect.append(fragment);

                // Inicjalizuj lub odśwież Select2
                autocompleteSelect.select2({
                    dropdownParent: $('#autocompleteModal'),
                    width: '100%'
                });
                // Aktualizacja ukrytego pola z wynikami wyboru - 'id' pacjenta
                autocompleteSelect
                    .off('change')
                    .on('change', function () {
                        const selectedOption = $(this).find(':selected');
                        const fullData = selectedOption.data('fullData');
                        const hiddenInput = $('#hiddenResultInput');
                        hiddenInput.val(fullData ? fullData[0] : '');
                    });
                // Otwórz modal
                $('#autocompleteModal').modal('show');
            }


            // ### Zdarzenia ###
            function bindEvents() {
                wojewodztwoSelect.on('change', function () {
                    const wojewodztwo = $(this).val();
                    if (wojewodztwo) {
                        loadCities(wojewodztwo);
                    } else {
                        console.error("Brak wybranego wojewodztwa!");
                    }
                });

                citySelect.on('change', function () {
                    const selectedCity = citySelect.find(":selected").text();
                    if (selectedCity && selectedCity !== "0") {
                        updateStreets();
                    }
                });

                $('#autocompleteSelect').on('select2:open', function () {
                    const select2Element = $(this).data('select2');
                    if (select2Element) {
                        // Wymuś wybór pierwszej dostępnej opcji
                        setTimeout(() => {
                            const firstOption = $(this).find('option:first').val();
                            if (firstOption) {
                                $(this).val(firstOption).trigger('change.select2');
                            }
                        }, 80); // Czas oczekiwania, aby Select2 zdążył się otworzyć
                    }
                });

                $('#autocompleteSelect').on('select2:select', function () {
                    // Pobierz zapisane dane z wybranego elementu select2
                    const selectedData = $(this).find('option:selected').data('fullData');

                    // Zamknij modal
                    $('#autocompleteModal').modal('hide');

                    const data = {
                        first_name: selectedData[1],
                        surname: selectedData[2],
                        pesel: selectedData[3],
                        new_woj: selectedData[5],
                        new_city: selectedData[6],
                        new_street: selectedData[7],
                        new_home_number: selectedData[8]
                    };
                    // Przenieś dane do pól
                    transferDataToInputs(data);
                });
            }

            async function transferDataToInputs(data) {
                try {
                    $('#first_name').val(data.first_name);
                    $('#surname').val(data.surname);
                    $('#pesel').val(data.pesel);
                    $('#home_numer').val(data.new_home_number);

                    const wojewodztwoSelect = $('#wojewodztwo');
                    const citySelect = $('#city_select');

                    // 1. Ustaw województwo
                    setSelect2OptionByText(wojewodztwoSelect, data.new_woj);

                    // 2. Poczekaj na załadowanie miast i ustaw miasto
                    await loadCities(data.new_woj);

                    setSelect2OptionByText(citySelect, data.new_city);

                    // 3. Po ustawieniu poczekaj na załadowanie ulic i ustaw ulicę
                    await updateStreets(data.new_street);

                    setSelect2OptionByText(streetSelect, data.new_street);
                } catch (error) {
                    console.error("Błąd podczas transferu danych:", error);
                }
            }

            // ### Autouzupełnianie ###
            function setupAutocomplete(inputId, field) {
                $(inputId).on('input', function () {
                    const query = $(this).val().trim();
                    // Sprawdź, czy zapytanie zawiera co najmniej 3 znaki.
                    if (query.length >= 3) {
                        $.ajax({
                            url: '/autocomplete', // Endpoint, który zwraca wyniki z bazy danych.
                            method: 'GET',
                            data: {query: query, field: field},
                            success: function (response) {
                                // Sprawdź, czy są wyniki w odpowiedzi
                                if (response && response.length > 0) {
                                    // Wywołaj modal i wypełnij jego zawartość
                                    populateAutocompleteModal(response);
                                } else {
                                    console.log("Brak wyników dla zapytania:", query);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                console.error("Błąd podczas autouzupełniania:", textStatus, errorThrown);
                            }
                        });
                    }
                });
            }

            setupAutocomplete('#surname', 'surname');
            setupAutocomplete('#pesel', 'pesel');

            // Przesunięcie modala z wynikami na wierzch
            $('#autocompleteModal').on('show.bs.modal', function () {
                // Pobierz obecny z-index modala rodzica (modalForm)
                const parentModalZIndex = parseInt($('#modalForm').css('z-index'));
                // Ustaw wyższy z-index dla nowego modala
                $(this).css('z-index', parentModalZIndex + 10);
            });

            $('#autocompleteModal').on('shown.bs.modal', function () {
                // Pamiętać, aby backdrop nowego modala również miał poprawny z-index
                const backdropZIndex = parseInt($(this).css('z-index')) - 1;
                $('.modal-backdrop').last().css('z-index', backdropZIndex);
            });
            // Inicjalizacja Select2 dla autocompleteSelect
            $('#autocompleteSelect').select2({
                dropdownParent: $('#autocompleteModal'),
                width: '100%'
            });

            function populateAutocompleteModal(results) {
                const autocompleteSelect = $('#autocompleteSelect');
                const fragment = document.createDocumentFragment();

                // Wyczyść istniejące opcje
                autocompleteSelect.empty();

                // Dodaj opis na belce startowej wyszukiwania
                const defaultOption = new Option('Lista rozwijana z wynikami ...', '', false, false);
                fragment.appendChild(defaultOption);

                // Dodaj nowe wyniki jako opcje, jeśli wyniki są dostępne
                if (results && results.length > 0) {
                    results.forEach((result) => {
                        // dodaj imię, nazwisko i pesel z 'result'
                        const displayText = result[1] + ' ' + result[2] + ' ' + result[3];
                        const newOption = new Option(displayText, result[0], false, false);
                        $(newOption).data('fullData', result); // dodaj cały 'result'
                        fragment.appendChild(newOption);
                    });
                } else {
                    // Dodaj opcję informującą o braku wyników
                    const noResultsOption = new Option('Brak wyników !', '', false, false);
                    fragment.appendChild(noResultsOption);
                }

                // Przenieś fragment do Select2
                autocompleteSelect.append(fragment);

                // Inicjalizuj lub odśwież Select2
                autocompleteSelect.select2({
                    dropdownParent: $('#autocompleteModal'),
                    width: '100%'
                });
                // Aktualizacja ukrytego pola z wynikami wyboru - 'id' pacjenta
                autocompleteSelect
                    .off('change')
                    .on('change', function () {
                        const selectedOption = $(this).find(':selected');
                        const fullData = selectedOption.data('fullData');
                        const hiddenInput = $('#hiddenResultInput');
                        hiddenInput.val(fullData ? fullData[0] : '');
                    });
                // Otwórz modal
                $('#autocompleteModal').modal('show');
            }

            $('#autocompleteSelect').on('select2:select', function () {
                // Pobierz zapisane dane z wybranego elementu select2
                const selectedData = $(this).find('option:selected').data('fullData');

                // Zamknij modal
                $('#autocompleteModal').modal('hide');

                const data = {
                    first_name: selectedData[1],
                    surname: selectedData[2],
                    pesel: selectedData[3],
                    new_woj: selectedData[5],
                    new_city: selectedData[6],
                    new_street: selectedData[7],
                    new_home_number: selectedData[8]
                };
                // Przenieś dane do pól
                transferDataToInputs(data);
            });

            // ### Inicjalizacja ###
            initializeSelect2();
            bindEvents();
            setupAutocomplete('#surname', 'surname');
            setupAutocomplete('#pesel', 'pesel');

            // ### Obsługa formularza i walidacji pesela ###
            const peselInput = document.querySelector('#pesel');
            const form = document.querySelector('#medical_certificate_form');

            // ### Walidacja PESEL ###
            function validatePesel(pesel) {
                if (!/^\d{11}$/.test(pesel)) {
                    return false; // Nieprawidłowa długość lub zawiera znaki inne niż cyfry
                }

                const weights = [9, 7, 3, 1, 9, 7, 3, 1, 9, 7];
                let sum = 0;

                for (let i = 0; i < 10; i++) {
                    sum += parseInt(pesel[i]) * weights[i];
                }

                const controlDigit = sum % 10;
                return controlDigit === parseInt(pesel[10]);
            }

            // Walidacja przy próbie wysyłania formularza
            form.addEventListener('submit', (event) => {
                const peselValue = peselInput.value;

                if (!validatePesel(peselValue)) {
                    event.preventDefault();                 // Zatrzymanie wysyłania formularza
                    showToast('PESEL jest nieprawidłowy!'); // Wyświetlenie toastu
                    peselInput.style.borderColor = 'red';   // Wizualne oznaczenie błędu
                }
            });

            // Funkcja czyszczenia formularza
            $('#clearForm').on('click', function () {
                $('#select2-typ-container').title = " Badanie profilaktyczne na wysokość";

                document.getElementById("medical_certificate_form").reset();
            });

            // KOPIUJ SKALĘ GRBAS do pola textarea
            document.getElementById("GRBAS").addEventListener("click", function () {
                const grade = document.getElementById("grade").value;
                const roughness = document.getElementById("roughness").value;
                const breathiness = document.getElementById("breathiness").value;
                const asthenic = document.getElementById("asthenic").value;
                const strained = document.getElementById("strained").value;
                const grbasText = ` Ocena odsłuchowa głosu: G${grade} R${roughness} B${breathiness} A${asthenic} S${strained}`;
                const infoField = document.getElementById("add_information");
                infoField.value += grbasText;
            });
        });
    </script>
</div>

</body>
</html>
