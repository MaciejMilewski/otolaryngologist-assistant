<!DOCTYPE html>

<html lang="pl">

<head>
    <meta http-equiv="content-type" content="application/json; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="{{ url_for('static',filename='img/logo.png') }}">

    <title>Orzeczenia lekarskie</title>

    <!-- Icon -->
    <link href="{{ url_for('static', filename='img/logo.png') }}" rel="shortcut icon">
    <!-- Import Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <!-- Import Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <!-- CSS forms_input_data.css -->
    <link href="{{ url_for('static', filename='css/medical_certificate.css') }}" rel="stylesheet">
    <!-- Import jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Import Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

</head>
<body>

<div class="col-12 text-center">
    <div class="row">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} text-center" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container col-12" id="mainForm">
        <!-- Pasek nawigacji -->
        <div class="row">
            <nav class="navbar fixed-top navbar-expand-lg navbar-light" style="background-color: #e3f2fd;">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="{{ url_for('static',filename='img/logo.png') }}" alt="" width="60" height="60"
                             class="d-inline-block align-text-top">
                    </a>
                    <a class="navbar-brand"><h5>{% if current_user.is_authenticated %}<b>{{ user }}</b>{% endif %}</h5>
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent"
                            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="btn btn-outline-primary" type="button"
                                   href="{{ url_for('antibiotic.antibiotic_main') }}">Antybiotykoterapia</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-success" type="button"
                                   href="{{ url_for('visit.main_form') }}">Badanie</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-secondary" type="button"
                                   href="{{ url_for('medical_certificate.medical_certificate_main') }}">Orzeczenia</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-warning" type="button"
                                   href="{{ url_for('patient.patient_main') }}">Szukaj
                                    pacjenta</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-info" type="button"
                                   href="{{ url_for('instruction.instruction_main') }}">Instrukcje</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-dark" type="button"
                                   href="{{ url_for('procedure.procedure_main') }}">Procedury
                                    NFZ</a>
                            </li>
                            &ensp;
                            <li class="nav-item">
                                <a class="btn btn-outline-dark" type="button"
                                   href="{{ url_for('schedule.schedule_main') }}">Terminarz</a>
                            </li>
                        </ul>
                        <a class="btn btn-danger" type="button" href="{{ url_for('auth.logout') }}">Wyloguj się</a>
                    </div>
                </div>
            </nav>
        </div>

        <div class="row d-flex align-items-stretch" style="margin-top: 96px;">
            <!-- Formularz 1 - orzeczenia -->
            <div class="col-md-8 mb-3">
                <div class="card h-100">
                    <div class="card-header mb-3 py-3">
                        <h4 class="mb-0"><span class="badge bg-success">ORZECZENIA LEKARSKIE</span></h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="typ">Typ orzeczenia</label>
                                <select id="typ" class="form-select select2" name="typ" aria-label="Typ badania">
                                    {% for choice in typ %}
                                        <option value="{{ choice['id'] }}"> {{ choice['name'] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="place">Lokalizacja</label>
                                <select id="place" class="form-select select2" name="place" aria-label="Lokalizacja">
                                    {% for locale in place %}
                                        <option value="{{ locale['name'] }}"> {{ locale['name'] }},
                                            dnia {{ today }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="add_information">ROZPOZNANIA / DODATKOWE INFORMACJE</label>
                            <textarea class="form-control" name="add_information" id="add_information"
                                      rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check d-flex justify-content-end align-items-center mb-3">
                                <label class="form-check-label ms-2 zdolny-label" for="zdolny">&nbsp;&nbsp; Zdolność do
                                    pracy</label>
                                <input class="form-check-input ms-2" type="checkbox" id="zdolny" name="zdolny" value="1"
                                       checked>
                            </div>
                        </div>

                        <div class="d-flex flex-wrap justify-content-between gap-2">
                            <button type="button" class="btn btn-danger flex-grow-1" id="clearForm">
                                <i class="bi bi-trash"></i> CZYŚĆ
                            </button>
                            <button type="button" class="btn btn-primary flex-grow-1" id="pdf_Form">
                                <i class="bi bi-file-earmark-pdf"></i> PDF
                            </button>
                            <button type="button" class="btn btn-success flex-grow-1" id="saveButton">
                                <i class="bi bi-save"></i> ZAPISZ
                            </button>
                            <button type="button" class="btn btn-info custom-raport-btn flex-grow-1" id="raportButton">
                                <i class="bi bi-bar-chart-line"></i> RAPORTY
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Formularz 2 - Skala Hirano -->
            <div class="col-md-4 mb-3">
                <div class="card ">
                    <div class="card-header py-3">
                        <h4 class="mb-0">
                            <span class="badge bg-success">Skala GRBAS</span>
                            <sup><i>&nbsp;wg Hirano, 1981</i></sup>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <label for="grade" class="me-2">G<i>-stopień chrypki</i></label>
                            <select name="grade" id="grade" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="roughness" class="me-2">R<i>-szorstkość głosu</i></label>
                            <select name="roughness" id="roughness" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="breathiness" class="me-2">B<i>–głos chuchający</i></label>
                            <select name="breathiness" id="breathiness" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="asthenic" class="me-2">A<i>–głos słaby, asteniczny</i></label>
                            <select name="asthenic" id="asthenic" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label for="strained" class="me-2">S<i>–głos hiperfunkcjonalny</i></label>
                            <select name="strained" id="strained" class="form-select form-select-sm">
                                <option value="0">0 - Normalny</option>
                                <option value="1">1 - Lekkie zmiany</option>
                                <option value="2">2 - Mierne zmiany</option>
                                <option value="3">3 - Ciężkie zmiany</option>
                            </select>
                        </div>
                        <button id="GRBAS" class="btn btn-success mt-3 w-100">
                            <i class="bi bi-check-circle"></i> ZATWIERDŹ
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal do wyboru osoby -->
    <div class="modal fade" id="selectPersonModal" tabindex="-1" role="dialog" aria-labelledby="selectPersonModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectPersonModalLabel">Znalezione osoby</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
                </div>
                <div class="modal-body">
                    <label for="personSelect" class="form-label">Wybierz osobę:</label>
                    <select id="personSelect" class="form-select">
                        <!-- Opcje zostaną załadowane dynamicznie przez JavaScript -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" id="selectPersonButton">Wybierz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <!-- Custom JS -->
    <script>
        $(document).ready(function () {

            // Inicjalizacja Select2 dla województwa, miejscowości i ulicy
            $('#wojewodztwo').select2({
                placeholder: "Wybierz województwo",
                allowClear: true,
                width: '100%'
            }).val('22').trigger('change.select2');  // Ustawienie domyślnej wartości "Pomorskie"

            $('#city').select2({
                placeholder: "Wybierz miejscowość",
                allowClear: true,
                width: '100%'
            });

            $('#street').select2({
                placeholder: "Wybierz ulicę",
                allowClear: true,
                width: '100%'
            });

            // Wczytanie miejscowości po wybraniu województwa
            $('#wojewodztwo').on('change', function () {
                let wojewodztwo = $(this).val();
                console.log("Wybrane województwo: " + wojewodztwo);

                if (!wojewodztwo) {
                    console.error("Brak wybranego województwa!");
                    return;
                }

                $.ajax({
                    url: '/get_miejscowosci',
                    type: 'POST',
                    data: {wojewodztwo: wojewodztwo},
                    success: function (response) {
                        $('#city').html('');  // Wyczyszczenie poprzednich opcji

                        if (response.miejscowosci && response.miejscowosci.length > 0) {
                            $.each(response.miejscowosci, function (index, city) {
                                $('#city').append(new Option(city[1], city[0]));
                            });
                            $('#city').val(response.miejscowosci[0][0]).trigger('change.select2'); // Ustawienie domyślnej wartości
                            $('#city').trigger('change');  // Ręczne wywołanie `change` dla aktualizacji ulic
                        } else {
                            console.error("Brak dostępnych miejscowości w odpowiedzi.");
                        }
                    },
                    error: function () {
                        alert("Błąd podczas pobierania miejscowości.");
                    }
                });
            });
            // Wczytanie ulic po wybraniu miejscowości
            $('#city').on('change', function () {
                let miejscowosc = $('#city option:selected').text().trim();
                let wojewodztwo = $('#wojewodztwo').val();

                if (!miejscowosc || !wojewodztwo) {
                    console.error("Brak miejscowości lub województwa");
                    return;
                }

                $.ajax({
                    url: '/get_ulice',
                    type: 'POST',
                    data: {miejscowosc: miejscowosc, wojewodztwo: wojewodztwo},
                    success: function (response) {
                        $('#street').html('');  // Wyczyszczenie poprzednich opcji

                        if (response.ulice && response.ulice.length > 0) {
                            $.each(response.ulice, function (index, street) {
                                $('#street').append(new Option(street, street));
                            });
                            // Ustaw pierwszą ulicę jako domyślną, jeśli dostępna
                            $('#street').val(response.ulice[0]).trigger('change.select2');
                        } else {
                            console.error("Brak dostępnych ulic w odpowiedzi.");
                        }
                    },
                    error: function () {
                        alert("Błąd podczas pobierania ulic.");
                    }
                });
            });

            // Funkcja do ustawiania danych w formularzu po wyborze osoby
            function setFormData(response) {
                $('#firstname').val(response.firstname);
                $('#lastname').val(response.lastname);
                $('#numer').val(response.number);
                $('#gender').val(response.gender);
                $('#add_information').val(response.info);
                $('#zdolny').prop('checked', response.able_to_work == 1);

                // Ustaw województwo
                if (response.stan) {
                    $('#wojewodztwo').val(response.stan).trigger('change.select2');
                }

                // Ustaw miasto
                if (response.city) {
                    $('#city').append(new Option(response.city, response.city, true, true)).trigger('change.select2');
                }

                // Ustaw ulicę
                if (response.street) {
                    $('#street').append(new Option(response.street, response.street, true, true)).trigger('change.select2');
                }
            }

            // Po wybraniu osoby w modal, pobierz szczegóły i ustaw w formularzu
            $('#selectPersonButton').on('click', function () {
                var selectedId = $('#personSelect').val();

                $.ajax({
                    url: '/get_person_details',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({'id': selectedId}),
                    success: function (response) {
                        setFormData(response);  // Ustaw dane w formularzu
                        $('#selectPersonModal').modal('hide');
                    },
                    error: function () {
                        alert('Błąd podczas pobierania danych osoby.');
                    }
                });
            });

            // Funkcja czyszczenia formularza
            $('#clearForm').on('click', function () {
                $('#firstname').val('');
                $('#lastname').val('');
                $('#numer').val('');
                $('#wojewodztwo').val(null).trigger('change.select2');
                $('#city').val(null).trigger('change.select2');
                $('#street').val(null).trigger('change.select2');
                $('#pesel').val('');
                $('#dowod').val('');
                $('#add_information').val('');
                $('#zdolny').prop('checked', true);
            });

            // Wyszukiwanie osoby na podstawie nazwiska
            $('#lastname').on('input', function () {
                var lastname = $(this).val();

                if (lastname.length >= 3) {
                    $.ajax({
                        url: '/search_by_lastname',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({'lastname': lastname}),
                        success: function (response) {
                            if (response.length > 0) {
                                var options = '';
                                response.forEach(function (person) {
                                    options += '<option value="' + person.id + '">' + person.firstname + ' ' + person.lastname + ', ' + person.city + '</option>';
                                });
                                $('#personSelect').html(options);
                                $('#selectPersonModal').modal('show');
                            }
                        },
                        error: function () {
                            alert('Błąd podczas wyszukiwania nazwiska.');
                        }
                    });
                }
            });

            // KOPIUJ SKALĘ GRBAS do pola textarea
            document.getElementById("GRBAS").addEventListener("click", function () {
                const grade = document.getElementById("grade").value;
                const roughness = document.getElementById("roughness").value;
                const breathiness = document.getElementById("breathiness").value;
                const asthenic = document.getElementById("asthenic").value;
                const strained = document.getElementById("strained").value;
                const grbasText = ` Ocena odsłuchowa głosu: G${grade} R${roughness} B${breathiness} A${asthenic} S${strained}`;
                const infoField = document.getElementById("add_information");
                infoField.value += grbasText;
            });

            // Przekierowanie na stronę SZUKAJ
            $('#searchButton').on('click', function () {
                window.location.href = '/search';
            });

            // Przekierowanie na stronę RAPORTY
            document.getElementById('raportButton').addEventListener('click', function () {
                window.location.href = '/raport';
            });

            // ZAPISZ DANE JAKO PLIK PDF
            $('#pdf_Form').on('click', function (e) {
                e.preventDefault();

                var formData = {
                    'firstname': $('#firstname').val(),
                    'lastname': $('#lastname').val(),
                    'pesel': $('#pesel').val(),
                    'dowod': $('#dowod').val(),
                    'wojewodztwo': $('#wojewodztwo').val(),
                    'city': $('#city option:selected').text().trim(),
                    'street': $('#street option:selected').text().trim(),
                    'numer': $('#numer').val(),
                    'typ': $('#typ').val(),
                    'zdolny': $('#zdolny').is(':checked') ? 'yes' : 'no',
                    'add_information': $('#add_information').val(),
                    'place': $('#place').val()
                };

                $.ajax({
                    url: '/pdf',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.file) {
                            window.location.href = '/pdf_download?file=' + encodeURIComponent(response.file);
                        } else {
                            alert('Błąd: brak ścieżki do pliku PDF.');
                        }
                    },
                    error: function () {
                        alert('Błąd przy generowaniu PDF.');
                    }
                });
            });

            // DRUKUJ DANE NA DRUKARCE
            $('#printButton').on('click', function (e) {
                e.preventDefault();

                let formData = {
                    'firstname': $('#firstname').val(),
                    'lastname': $('#lastname').val(),
                    'pesel': $('#pesel').val(),
                    'dowod': $('#dowod').val(),
                    'city': $('#city').val(),
                    'street': $('#street').val(),
                    'numer': $('#numer').val(),
                    'typ': $('#typ').val(),
                    'zdolny': $('#zdolny').is(':checked') ? 'yes' : 'no',
                    'add_information': $('#add_information').val(),
                    'place': $('#place').val()
                };

                $.ajax({
                    url: '/print',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        $('#printContainer').html(response);
                        $('#mainForm').hide();
                        $('#printContainer').show();
                        window.print();
                        $('#mainForm').show();
                        $('#printContainer').hide();
                    },
                    error: function () {
                        alert('Wystąpił błąd podczas drukowania.');
                    }
                });
            });

            $('#saveButton').on('click', function (e) {
                e.preventDefault();

                let isValid = true;

                if (isValid) {
                    var formData = {
                        'typ': $('#typ').val(),
                        'zdolny': $('#zdolny').is(':checked') ? '1' : '0',
                        'add_information': $('#add_information').val(),
                        'place': $('#place').val(),
                        'gender': $('#gender').val()
                    };

                    $.ajax({
                        url: '/save',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        success: function (response) {
                            alert('Dane zostały zapisane pomyślnie');
                        },
                        error: function () {
                            alert('Wystąpił błąd podczas zapisu danych');
                        }
                    });
                }
            });
        });

    </script>
</div>

</body>
</html>


{#<div class="container col-12" id="mainForm">#}
{#    <!-- Pasek nawigacji -->#}
{#    <div class="row"></div>#}
{##}
{#    <div class="row d-flex align-items-stretch">#}
{#        <!-- Formularz 1 - orzeczenia -->#}
{#        <div class="col-md-8 mb-3"></div>#}
{##}
{#        <!-- Formularz 2 - Skala Hirano -->#}
{#        <div class="col-md-4 mb-3"></div>#}
{#    </div>#}
{#</div>#}